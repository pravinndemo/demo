
---

## **Summary of the Discussion**

1. **Environment Constraints & Single Feasible Option**

   * Creating a **new DEV environment** as a full replica (Dynamics, Azure Functions, Postgres, integrations, etc.) would take **2‚Äì3 months**, per DevOps consultation with Scott/Kyle/Mark.
   * Therefore, the **only viable short-term option** is to use the **Hotfix environment** for the Welsh PoC.

2. **Status of Hotfix Environment**

   * Hotfix was originally planned for **decommissioning**; Helen is aware of the PoC, but **formal confirmation is required** to repurpose it.
   * Hotfix needs to be updated to **latest PROD code (v1.7)** before use.
   * Significant lead-time is expected (mid‚Äìlate January) due to **Christmas period** and **resource constraints**.

3. **DAL / Dynamics Integration Clarifications**

   * DAL team already created a **Dev POC environment**, and it is functional.
   * The proposal is to **point the Hotfix Dynamics environment to the DAL DevPOC APIs** (cross-environment integration).
   * Architecturally this is not ideal ("crossing environments"), but **may be allowed for a PoC if approved by business/Helen**.

4. **Concerns Raised by DAL Team (Alan/Steve)**

   * Unclear whether this PoC is **temporary** (until end of January) or a **long-term environment**; messaging has been inconsistent.
   * Without clarity, teams are unsure whether to invest effort in updates and provisioning.
   * Hotfix + DAL POC combination could technically work, but requires **business approval** due to non-standard architecture.

5. **Deployment Timeline Risks**

   * Hotfix hasn‚Äôt been updated since **1.4**; updating now may cause issues because:

     * PPE deployment is scheduled next week.
     * Limited resources after that.
   * Realistically, Hotfix cannot be fully updated by end of this month.
   * Bringing DAL into Hotfix alone pushes readiness to **mid/late January**.

6. **Next Steps & Actions**

   * A call with **Helen at 3:30 PM** will seek clarity and approval on:

     * Whether Hotfix can be repurposed for the Welsh PoC.
     * Whether crossing Hotfix (Dynamics) with DevPOC (DAL) is acceptable.
     * Confirmation on wave update expectations.
   * Praveen will document:

     * What is needed on Dynamics + DAL integrations.
     * The exact requirement for Hotfix ‚Üí DAL DevPOC connectivity.
   * Once approval is received, teams (Dynamics + DAL + DevOps) will prepare a **plan to bring Hotfix up to scratch** for the PoC.

---

## **Overall Conclusion**

* **Only feasible option**: use **Hotfix** for PoC (due to long provisioning time for a new environment).
* **Critical blocker**: need **Helen‚Äôs approval** to repurpose Hotfix and allow cross-environment integration with DAL DevPOC.
* **Timeline risk**: even with approval, full readiness may not be possible before **mid/late January**.
* The 3:30 PM call is essential to confirm business direction before teams proceed.

---




---

# **How Dynamics Accesses DAL (Simple Explanation)**

Dynamics does **not** call the DAL API directly.
It follows a secure, multi-step authentication flow using **Azure AD ‚Üí APIM ‚Üí DAL**.

### **1. Dynamics reads the authentication details from Secure Configuration**

The plugin reads the following values from **Secure Configuration** (so nothing is hard-coded):

* **ClientId** ‚Äì the App Registration used by Dynamics
* **ClientSecret** ‚Äì stored securely
* **TenantId** ‚Äì Azure AD tenant
* **Scope** ‚Äì the API permission for APIM (e.g., `api://‚Ä¶/.default`)
* **APIM Subscription Key** ‚Äì APIM‚Äôs product/subscription authentication
* **Address** ‚Äì APIM endpoint URL

These values are loaded at runtime:

```csharp
APIRequestConfiguration APIRequestConfiguration = new APIRequestConfiguration
{
    Address = (string)getSecretsResponse.Results["Address"],
    ClientId = (string)getSecretsResponse.Results["ClientId"],
    ClientSecret = (string)getSecretsResponse.Results["ClientSecret"],
    TenantId = (string)getSecretsResponse.Results["TenantId"],
    Scope = (string)getSecretsResponse.Results["Scope"],
    APIMSubscriptionKey = (string)getSecretsResponse.Results["APIMSubscriptionKey"]
};
```

So **Dynamics never hardcodes secrets** ‚Äî all authentication parameters come from secure configuration.

---

# **2. Dynamics generates a Bearer token using OAuth 2.0 (Client Credentials Flow)**

Dynamics calls Azure AD:

```
POST https://login.microsoftonline.com/{TenantId}/oauth2/v2.0/token
grant_type=client_credentials  
client_id=...
client_secret=...
scope=...
```

Azure AD returns:

* **Access Token (JWT)** ‚Äì signed token that APIM will validate
* **Expiry** ‚Äì usually 1 hour

This is what your plugin code does in `GenerateAuthentication()`.

---

# **3. Dynamics calls APIM using:**

* **Bearer Token** (from Azure AD)
* **APIM Subscription Key**
* **Endpoint Address** (APIM URL)

```
Authorization: Bearer {AAD Access Token}
Ocp-Apim-Subscription-Key: {Subscription Key}
```

This is step **3** in the sequence diagram.

---

# **4. APIM validates the token**

APIM checks:

* **appid** ‚Äì matches Dynamics App Registration
* **audience (aud)** ‚Äì matches the API appId
* **roles / scopes** ‚Äì correct permissions

If valid ‚Üí APIM forwards the request.

If not ‚Üí APIM rejects with **401/403**.

---

# **5. APIM uses Managed Identity to call DAL**

APIM does **not** forward Dynamics‚Äô token.

Instead:

* APIM authenticates to DAL using **its Managed Identity**.
* DAL trusts APIM‚Äôs MI, not Dynamics directly.

(Your step 5 in diagram.)

---

# **6. DAL returns the response ‚Üí APIM ‚Üí Dynamics**

APIM receives DAL response
‚Üí returns it back to Dynamics as step **7**.

---

# **High-Level Summary (One Line)**

**Dynamics authenticates to APIM using Azure AD + Subscription Key, and APIM then calls DAL using its Managed Identity. All credentials (client Id, secret, tenant, scope, subscription key) are stored securely in Dynamics Secure Configuration.**

---



---

# ‚úÖ **Is APIM restricting based on Dynamics environment?**

**No. APIM does NOT restrict requests based on the Dynamics environment.**

APIM restricts ONLY based on:

1. **The ClientId (appid) in the JWT**
2. **The Audience (aud) the token is issued for**
3. **The roles/scopes inside the token**
4. **The APIM subscription key used**

Nothing in APIM checks:

‚ùå The URL of your Dynamics environment
‚ùå Whether the call came from DEV, POC, Hotfix, or PROD
‚ùå Any Dynamics-specific metadata

APIM only cares about the **token + subscription key**, not which Dynamics instance generated it.

---

# ‚úÖ **So if we use the same plugin configuration in another Dynamics environment (POC)‚Ä¶ will it work?**

**Yes ‚Äî it will work exactly the same**, as long as:

### üîπ The plugin is configured with the same:

* **ClientId**
* **ClientSecret**
* **TenantId**
* **Scope**
* **APIM Subscription Key**
* **APIM URL**

Then Dynamics ‚Üí Azure AD ‚Üí APIM authentication remains **unchanged**.

Nothing in APIM or Azure AD knows or cares which Dynamics environment the plugin is running in.

---

# ‚ö†Ô∏è When could it fail?

Only in these cases:

### ‚ùå If the POC Dynamics uses a **different clientId/secret**

‚Üí Token will not match APIM expected `appid`

### ‚ùå If the POC Dynamics uses a **different scope**

‚Üí Token `aud` won‚Äôt match APIM‚Äôs configured audience

### ‚ùå If APIM subscription key is not included

‚Üí APIM will reject the request regardless of environment

But **if you use the SAME secure values**, everything works without modification.

---

# üîê **Why this works**

The authentication flow depends entirely on:

### ‚úî App Registration (ClientId / Secret)

### ‚úî Token claims

### ‚úî APIM subscription key

**None of these are environment-dependent.**

Two completely different Dynamics environments
‚Üí using the same plugin configuration
‚Üí will generate the *same type* of JWT
‚Üí which APIM will accept.

---

# ‚úÖ **One-line, direct answer for your meeting**

**‚ÄúAPIM does not validate the Dynamics environment. It only validates the Azure AD token and the subscription key. So if our plugin carries the same ClientId, Secret, Scope, and APIM key, the POC environment will work exactly the same as DEV.‚Äù**

---




