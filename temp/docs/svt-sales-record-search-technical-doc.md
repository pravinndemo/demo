# SVT Sales Record Search: Filters & Technical Flow

## Purpose
This page documents the **Sales Record Search** experience used by the SVT List PCF control. It covers:
- The **attributes/columns** displayed in the grid.
- The **filter controls** available in the UI (top-of-grid search and column header filters).
- How the PCF control **sanitizes**, **maps**, and **sends** filters to the Dataverse Custom API.
- The **backend plugin** that forwards the request to APIM and returns results.

The goal is to provide a single reference that can be used for a Confluence or Azure DevOps wiki page.

---

## High-level flow (end-to-end)
1. **User enters filters in the PCF grid UI** (search panel or column header filters). The filter types, UI control types, and constraints are defined in `DetailsListVOA/Grid.tsx` and `DetailsListVOA/config/TableConfigs.ts`.【F:DetailsListVOA/Grid.tsx†L150-L352】【F:DetailsListVOA/config/TableConfigs.ts†L32-L156】
2. **Filters are sanitized** (trimmed, length validated, numeric modes validated) in `DetailsListVOA/Filters.ts`.【F:DetailsListVOA/Filters.ts†L70-L231】
3. **API parameters are built** in `buildSalesParams` and `buildApiParamsFor` and added to the custom API call from `GridDataController.loadGridData`.【F:DetailsListVOA/config/TableConfigs.ts†L78-L212】【F:DetailsListVOA/services/GridDataController.ts†L33-L123】
4. **Dataverse Custom API is invoked** through `Xrm.WebApi.execute` using the unbound request defined in `CustomApi.ts`.【F:DetailsListVOA/services/CustomApi.ts†L23-L73】
5. **Custom API plugin forwards the request to APIM** and returns the JSON response via `Result` in `GetAllSalesRecord.cs`.【F:VOA.SVT.Plugins/Plugins/CustomAPI/GetAllSalesRecord.cs†L18-L118】
6. **Client normalizes the response** into `TaskSearchResponse` for the grid using `normalizeSearchResponse` in `DataService.ts`.【F:DetailsListVOA/services/DataService.ts†L94-L188】【F:DetailsListVOA/services/DataService.ts†L270-L286】

---

## Attributes / Grid Columns
The Sales Record grid uses the **sales column profile** to define the visible attributes and column labels. The following columns are configured in `DetailsListVOA/config/ColumnProfiles.ts`:【F:DetailsListVOA/config/ColumnProfiles.ts†L5-L34】

| Attribute | Column Label | Notes |
| --- | --- | --- |
| Sale ID | Sale ID | Link cell (clickable). User-friendly ID format (e.g., `S-1000001`).【F:DetailsListVOA/config/ColumnProfiles.ts†L5-L13】【F:DetailsListVOA/Grid.tsx†L195-L206】 |
| Task ID | Task ID | Autogenerated: `A-1000001` etc. Manual: `M-1000001` etc. (UI placeholder).【F:DetailsListVOA/Grid.tsx†L196-L202】 |
| UPRN | UPRN | Numeric-only input in the filter UI.【F:DetailsListVOA/Grid.tsx†L200-L209】 |
| Address | Address | Rendered as a link to the hereditament in VOS when `addressurl` is present.【F:DetailsListVOA/grid/GridCell.tsx†L95-L130】【F:DetailsListVOA/components/DetailsListHost/DetailsListHost.tsx†L409-L451】 |
| Post code | Post code | Prefix search (min 2 chars).【F:DetailsListVOA/Grid.tsx†L216-L224】 |
| Billing Authority | Billing Authority | Multi-select, limited to 3 selections.【F:DetailsListVOA/Grid.tsx†L225-L232】 |
| Transaction Date | Transaction Date | Date range search with from/to values.【F:DetailsListVOA/Grid.tsx†L232-L234】 |
| Sale Price | Sale Price | Numeric filter with >= / <= / between modes.【F:DetailsListVOA/Grid.tsx†L234-L236】 |
| Ratio | Ratio | Numeric filter with >= / <= / between modes.【F:DetailsListVOA/Grid.tsx†L235-L236】 |
| Dwelling Type | Dwelling Type | Multi-select with select-all option.【F:DetailsListVOA/Grid.tsx†L237-L244】 |
| Flagged for review | Flagged for review | Yes/No dropdown (single select).【F:DetailsListVOA/Grid.tsx†L245-L255】 |
| Review Flags | Review Flags | Multi-select with select-all option.【F:DetailsListVOA/Grid.tsx†L256-L264】 |
| Outlier Ratio | Outlier Ratio | Numeric filter with >= / <= / between modes.【F:DetailsListVOA/Grid.tsx†L265-L266】 |
| Overall flag | Overall flag | Multi-select with select-all option; includes Exclude/Investigate/etc values.【F:DetailsListVOA/Grid.tsx†L267-L289】 |
| Summary flag | Summary flag | Text contains search (min 3 chars).【F:DetailsListVOA/Grid.tsx†L290-L296】 |
| Task status | Task status | Multi-select with select-all option (lookup).【F:DetailsListVOA/Grid.tsx†L297-L305】 |
| Assigned to | Assigned to | Single-select (lookup).【F:DetailsListVOA/Grid.tsx†L306-L311】 |
| Assigned date | Assigned date | Date range search with from/to values.【F:DetailsListVOA/Grid.tsx†L312-L313】 |
| Task completed date | Task completed date | Date range filter in column header filters. (Column config).【F:DetailsListVOA/config/TableConfigs.ts†L70-L76】 |
| QC Assigned to | QC Assigned to | Single-select (lookup).【F:DetailsListVOA/Grid.tsx†L314-L319】 |
| QC Assigned date | QC Assigned date | Date range search with from/to values.【F:DetailsListVOA/Grid.tsx†L320-L321】 |
| QC completed date | QC completed date | Date range search with from/to values.【F:DetailsListVOA/Grid.tsx†L322-L323】 |

---

## Filter controls (UI + validation)

### Top-of-grid search panel
The search panel uses **SearchByOptions** and control types defined in `Grid.tsx`. Each option maps to a control type (text, numeric, date range, single select, multi select, etc.).【F:DetailsListVOA/Grid.tsx†L124-L352】

### Validation and sanitization rules
Filters are normalized before being sent to the API. Key rules in `sanitizeFilters` include:【F:DetailsListVOA/Filters.ts†L70-L231】
- **UPRN** is stripped to digits only.
- **Sale ID / Task ID** are trimmed; empty values are dropped.
- **Address** requires a minimum of 3 characters.
- **Post code** requires a minimum of 2 characters and is uppercased.
- **Billing Authority** is trimmed and limited to **max 3** selections.
- **Numeric filters** (Sale Price, Ratio, Outlier Ratio) enforce valid **mode + min/max** combinations.
- **Summary flag** uses a minimum length of 3.

---

## Column header filters
Column header filters (shown via column menus) use **column filter configuration** from `SALES_COLUMN_FILTERS`. This is a separate config from the top-of-grid search panel, but the filter definitions match the same fields and constraints.【F:DetailsListVOA/config/TableConfigs.ts†L32-L76】

Examples:
- `saleid`, `taskid`, `uprn`: `textEq` filters.
- `address`: `textContains` with min length 3.
- `postcode`: `textPrefix` with min length 2.
- `billingauthority`: `multiSelect` with max 3.
- `saleprice`, `ratio`, `outlierratio`: `numeric` filters.
- `assigneddate`, `taskcompleteddate`, `qcassigneddate`, `qccompleteddate`: `dateRange` filters.

---

## API parameter mapping (client → Dataverse Custom API)

### Custom API name and type
The default Custom API name for the grid is `voa_GetAllSalesRecord`, defined in `CONTROL_CONFIG`. The type defaults to `function`. Both values can be overridden via PCF input parameters and are normalized in `GridDataController`.【F:DetailsListVOA/config/ControlConfig.ts†L1-L8】【F:DetailsListVOA/services/GridDataController.ts†L13-L45】

### Parameter mapping
`buildSalesParams` constructs the parameter dictionary sent to the Custom API. It converts the UI filters into **string parameters** required by `Xrm.WebApi.execute` and the plugin. The most relevant mappings are:【F:DetailsListVOA/config/TableConfigs.ts†L78-L212】

| UI Filter | API Param(s) | Notes |
| --- | --- | --- |
| Sale ID | `saleId` | Text equals.
| Task ID | `taskId` | Text equals.
| UPRN | `uprn` | Digits only.
| Address | `address` | Text contains.
| Post code | `postcode` | Starts-with prefix.
| Billing Authority | `billingAuthority` | Comma-separated list (max 3).
| Transaction Date | `transactionDate` | Date string (from/to logic uses from when both provided).
| Sale Price | `salesPrice`, `salesPriceOperator` | Operator is `GE` or `LE`.
| Ratio | `ratio` | Only value passed (operator implicit).
| Dwelling Type | `dwellingType` | Comma-separated list.
| Flagged for review | `flaggedForReview` | `true`/`false`.
| Review Flags | `reviewFlag` | Comma-separated list.
| Outlier Ratio | `outlierRatio` | Numeric range logic.
| Overall flag | `overallFlag` | Comma-separated list.
| Summary flag | `summaryFlag` | Text contains.
| Task status | `taskStatus` | Comma-separated list.
| Assigned to | `assignedTo` | Single value.
| Assigned date | `assignedFromDate`, `assignedToDate` | From/to values.
| QC Assigned to | `qcAssignedTo` | Single value.
| QC Assigned date | `qcAssignedFromDate`, `qcAssignedToDate` | From/to values.
| QC completed date | `qcCompleteFromDate`, `qcCompleteToDate` | From/to values.

### Paging and sorting
`pageNumber`, `pageSize`, `sortField`, and `sortDirection` are added in `loadGridData` to support grid paging and sorting.【F:DetailsListVOA/services/GridDataController.ts†L47-L102】

---

## Dataverse Custom API execution (client)
The PCF control uses an **unbound Custom API request** built in `buildUnboundCustomApiRequest` and executed via `Xrm.WebApi.execute`. All parameters are sent as strings. The request metadata is assembled in `CustomApi.ts`.【F:DetailsListVOA/services/CustomApi.ts†L23-L73】

---

## Backend plugin (Dataverse → APIM)
The Custom API plugin `GetAllSalesRecord` handles the server-side call:
1. Loads API configuration from `voa_CredentialProvider`.
2. Builds the APIM URL with query string parameters from `CustomApiQueryHelper.BuildSearchQuery`.
3. Executes the HTTP GET to APIM and returns the JSON payload as `Result`.

Relevant files:
- `VOA.SVT.Plugins/Plugins/CustomAPI/GetAllSalesRecord.cs`【F:VOA.SVT.Plugins/Plugins/CustomAPI/GetAllSalesRecord.cs†L18-L118】
- `VOA.SVT.Plugins/Plugins/CustomAPI/Helpers/CustomApiQueryHelper.cs`【F:VOA.SVT.Plugins/Plugins/CustomAPI/Helpers/CustomApiQueryHelper.cs†L9-L89】
- `VOA.SVT.Plugins/Plugins/CustomAPI/DataAccessLayer/Model/SalesRecordModels.cs` (query string parameter normalization).【F:VOA.SVT.Plugins/Plugins/CustomAPI/DataAccessLayer/Model/SalesRecordModels.cs†L9-L129】

---

## Response handling and grid binding
The PCF normalizes API responses into `TaskSearchResponse` in `DataService.ts`:
- Accepts either `SalesApiResponse` (with `sales` + `pageInfo`) or already-normalized `TaskSearchResponse`.
- Maps records into `TaskSearchItem` and then into dataset records for the grid.

Relevant methods:
- `normalizeSearchResponse` (response shape normalization).【F:DetailsListVOA/services/DataService.ts†L270-L286】
- `normalizeSalesItem` (field mapping, including flags and arrays).【F:DetailsListVOA/services/DataService.ts†L185-L245】
- `mapTaskItemToRecord` (grid record mapping).【F:DetailsListVOA/services/DataService.ts†L356-L430】

---

## Configuration touchpoints

| Configuration | Location | Notes |
| --- | --- | --- |
| Custom API name/type | `DetailsListVOA/config/ControlConfig.ts` | Defaults to `voa_GetAllSalesRecord` and `function`.【F:DetailsListVOA/config/ControlConfig.ts†L1-L8】 |
| Search options (top panel) | `DetailsListVOA/config/TableConfigs.ts` | `searchByOptions` per table/persona.【F:DetailsListVOA/config/TableConfigs.ts†L214-L319】 |
| Column filter config | `DetailsListVOA/config/TableConfigs.ts` | `SALES_COLUMN_FILTERS`.【F:DetailsListVOA/config/TableConfigs.ts†L32-L76】 |
| Column labels | `DetailsListVOA/config/ColumnProfiles.ts` | Column display names and widths.【F:DetailsListVOA/config/ColumnProfiles.ts†L5-L34】 |

---

## Reference: Filters matrix (UI → API)
This table aligns the story requirements with the implementation.

| Column Name | UI Control | Notes (validation) | API Param(s) |
| --- | --- | --- | --- |
| Sale ID | Textbox (equal) | User-friendly `S-1000001` format placeholder. | `saleId`【F:DetailsListVOA/Grid.tsx†L195-L206】【F:DetailsListVOA/config/TableConfigs.ts†L96-L118】 |
| Task ID | Textbox (equal) | Placeholder includes A-/M- formats. | `taskId`【F:DetailsListVOA/Grid.tsx†L196-L202】【F:DetailsListVOA/config/TableConfigs.ts†L98-L120】 |
| UPRN | Textbox (equal) | Numeric-only filter input. | `uprn`【F:DetailsListVOA/Grid.tsx†L203-L211】【F:DetailsListVOA/config/TableConfigs.ts†L98-L120】 |
| Address | Textbox (contains) | Min 3 characters. Address link uses `addressurl`. | `address`【F:DetailsListVOA/Grid.tsx†L212-L218】【F:DetailsListVOA/grid/GridCell.tsx†L95-L130】 |
| Post code | Textbox (starts with) | Min 2 characters, uppercased. | `postcode`【F:DetailsListVOA/Grid.tsx†L216-L224】【F:DetailsListVOA/config/TableConfigs.ts†L98-L121】 |
| Billing Authority | Dropdown (multi) | Max 3 selections. | `billingAuthority` (comma-separated)【F:DetailsListVOA/Grid.tsx†L225-L232】【F:DetailsListVOA/config/TableConfigs.ts†L108-L123】 |
| Transaction Date | Date range | From/to values. | `transactionDate`【F:DetailsListVOA/Grid.tsx†L232-L234】【F:DetailsListVOA/config/TableConfigs.ts†L122-L137】 |
| Sale Price | Numeric | >= / <= / between (min/max). | `salesPrice`, `salesPriceOperator`【F:DetailsListVOA/Grid.tsx†L234-L236】【F:DetailsListVOA/config/TableConfigs.ts†L138-L162】 |
| Ratio | Numeric | >= / <= / between (min/max). | `ratio`【F:DetailsListVOA/Grid.tsx†L235-L236】【F:DetailsListVOA/config/TableConfigs.ts†L163-L177】 |
| Dwelling Type | Dropdown (multi) | Select all supported. | `dwellingType`【F:DetailsListVOA/Grid.tsx†L237-L244】【F:DetailsListVOA/config/TableConfigs.ts†L178-L178】 |
| Flagged for review | Dropdown (Yes/No) | Single-select. | `flaggedForReview`【F:DetailsListVOA/Grid.tsx†L245-L255】【F:DetailsListVOA/config/TableConfigs.ts†L179-L180】 |
| Review Flags | Dropdown (multi) | Select all supported. | `reviewFlag`【F:DetailsListVOA/Grid.tsx†L256-L264】【F:DetailsListVOA/config/TableConfigs.ts†L180-L181】 |
| Outlier Ratio | Numeric | >= / <= / between. | `outlierRatio`【F:DetailsListVOA/Grid.tsx†L265-L266】【F:DetailsListVOA/config/TableConfigs.ts†L185-L195】 |
| Overall flag | Dropdown (multi) | Values: Exclude/Investigate/etc; select all. | `overallFlag`【F:DetailsListVOA/Grid.tsx†L267-L289】【F:DetailsListVOA/config/TableConfigs.ts†L196-L207】 |
| Summary flag | Text (contains) | Min 3 characters. | `summaryFlag`【F:DetailsListVOA/Grid.tsx†L290-L296】【F:DetailsListVOA/config/TableConfigs.ts†L208-L208】 |
| Task status | Dropdown (multi) | Select all supported. | `taskStatus`【F:DetailsListVOA/Grid.tsx†L297-L305】【F:DetailsListVOA/config/TableConfigs.ts†L209-L209】 |
| Assigned to | Dropdown (single) | Lookup field. | `assignedTo`【F:DetailsListVOA/Grid.tsx†L306-L311】【F:DetailsListVOA/config/TableConfigs.ts†L210-L210】 |
| Assigned date | Date range | From/to values. | `assignedFromDate`, `assignedToDate`【F:DetailsListVOA/Grid.tsx†L312-L313】【F:DetailsListVOA/config/TableConfigs.ts†L211-L214】 |
| Task completed date | Date range | Column header filter (date range control). | Column header filter for `taskcompleteddate`.【F:DetailsListVOA/config/TableConfigs.ts†L70-L76】 |
| QC Assigned to | Dropdown (single) | Lookup field. | `qcAssignedTo`【F:DetailsListVOA/Grid.tsx†L314-L319】【F:DetailsListVOA/config/TableConfigs.ts†L214-L216】 |
| QC Assigned date | Date range | From/to values. | `qcAssignedFromDate`, `qcAssignedToDate`【F:DetailsListVOA/Grid.tsx†L320-L321】【F:DetailsListVOA/config/TableConfigs.ts†L214-L218】 |
| QC completed date | Date range | From/to values. | `qcCompleteFromDate`, `qcCompleteToDate`【F:DetailsListVOA/Grid.tsx†L322-L323】【F:DetailsListVOA/config/TableConfigs.ts†L219-L221】 |

---

## Additional technical notes
- **Address hyperlink**: if the dataset record includes `suid`, the host builds a `addressurl` pointing to the SSU (hereditament) in VOS and renders the `address` column as a link.【F:DetailsListVOA/components/DetailsListHost/DetailsListHost.tsx†L409-L451】【F:DetailsListVOA/grid/GridCell.tsx†L95-L130】
- **Sale ID is treated as a user-friendly ID**, not a GUID. The UI placeholder explicitly uses `S-1000001` and the `saleId` field is mapped directly to API parameters and grid rows.【F:DetailsListVOA/Grid.tsx†L195-L206】【F:DetailsListVOA/config/TableConfigs.ts†L96-L118】
- **Review flags, summary flags, and overall flags** are modeled as arrays in the response mapping to support multi-select filters and tag rendering in the grid.【F:DetailsListVOA/services/DataService.ts†L185-L245】

---

## References
- `docs/svtGetSaleRecords.md` is a general Custom API overview and can be used as a supplement for API execution behavior and response mapping details.【F:docs/svtGetSaleRecords.md†L1-L198】
